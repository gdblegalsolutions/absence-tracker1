<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Absence Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Avenir Next', 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
        }

        .content {
            padding: 20px 0;
        }

        .section {
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 28px;
            color: #1a1a1a;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 2px solid #000000;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .info-box {
            background: #f8f8f8;
            border-left: 3px solid #000000;
            padding: 25px;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .info-box h3 {
            color: #1a1a1a;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 400;
        }

        .info-box p {
            color: #333333;
            line-height: 1.8;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 15px;
        }

        .info-box li {
            color: #333333;
            margin-bottom: 10px;
            line-height: 1.8;
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #1a1a1a;
            font-weight: 400;
            font-size: 15px;
        }

        input[type="date"],
        input[type="number"],
        select,
        input[type="checkbox"] {
            font-family: 'Avenir Next', 'Helvetica Neue', Arial, sans-serif;
        }

        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid #cccccc;
            border-radius: 0;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #000000;
            box-shadow: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        .button {
            background: #000000;
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 15px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 400;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-family: 'Avenir Next', 'Helvetica Neue', Arial, sans-serif;
        }

        .button:hover {
            background: #333333;
        }

        .button:active {
            transform: scale(0.98);
        }

        .button-secondary {
            background: #f8f8f8;
            color: #1a1a1a;
            border: 1px solid #cccccc;
        }

        .button-secondary:hover {
            background: #eeeeee;
        }

        .trips-list {
            margin-top: 25px;
        }

        .trip-item {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .trip-item:hover {
            border-color: #000000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .trip-item.permitted {
            background: #e8f5e9;
            border-left: 3px solid #4caf50;
        }

        .trip-item.outside-period {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            opacity: 0.7;
        }

        .trip-item.pre-entry {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .trip-item.after-submission {
            background: #fce4ec;
            border-left: 3px solid #e91e63;
            opacity: 0.7;
        }

        .trip-info {
            flex: 1;
        }

        .trip-info strong {
            color: #1a1a1a;
            display: block;
            margin-bottom: 6px;
            font-weight: 400;
        }

        .trip-info span {
            color: #666666;
            font-size: 14px;
        }

        .trip-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 0;
            font-size: 12px;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        .trip-badge.excluded {
            background: #ffc107;
            color: #856404;
        }

        .trip-badge.pre-entry {
            background: #2196f3;
            color: white;
        }

        .trip-badge.after-submission {
            background: #e91e63;
            color: white;
        }

        .trip-days {
            background: #000000;
            color: white;
            padding: 10px 20px;
            border-radius: 0;
            font-weight: 400;
            margin-right: 15px;
            letter-spacing: 0.5px;
        }

        .trip-days.permitted {
            background: #4caf50;
        }

        .trip-days.excluded {
            background: #ffc107;
            color: #856404;
        }

        .trip-days.pre-entry {
            background: #2196f3;
        }

        .trip-days.after-submission {
            background: #e91e63;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 400;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .results {
            background: #1a1a1a;
            color: white;
            padding: 40px;
            border-radius: 0;
            margin-top: 40px;
        }

        .results h3 {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 0;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .result-item strong {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-item .value {
            font-size: 32px;
            font-weight: 300;
        }

        .result-item .sub-value {
            font-size: 16px;
            margin-top: 10px;
            opacity: 0.9;
        }

        .status {
            text-align: center;
            padding: 25px;
            border-radius: 0;
            margin-top: 25px;
            font-weight: 400;
            font-size: 18px;
            letter-spacing: 0.5px;
        }

        .status.pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 20px;
            border-radius: 0;
            margin-top: 25px;
        }

        .warning p {
            color: #856404;
            line-height: 1.8;
            margin-bottom: 10px;
            font-size: 15px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 10px 0;
            }

            .section-title {
                font-size: 22px;
            }

            .trip-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .trip-days {
                margin-right: 0;
            }

            .result-item .value {
                font-size: 26px;
            }
        }

        .hidden {
            display: none;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 640px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .highlight-box {
            background: #f8f8f8;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }

        .highlight-box p {
            color: #1a1a1a;
            line-height: 1.8;
            margin-bottom: 8px;
        }

        .highlight-box strong {
            color: #000000;
        }

        .eligibility-box {
            background: #e8f5e9;
            border-left: 3px solid #4caf50;
            padding: 25px;
            margin-bottom: 25px;
        }

        .eligibility-box.warning {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .eligibility-box.error {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
        }

        .eligibility-box h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 400;
        }

        .eligibility-box.warning h4 {
            color: #856404;
        }

        .eligibility-box.error h4 {
            color: #721c24;
        }

        .eligibility-box p {
            color: #1b5e20;
            line-height: 1.8;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .eligibility-box.warning p {
            color: #856404;
        }

        .eligibility-box.error p {
            color: #721c24;
        }

        .permitted-reasons {
            background: #e8f5e9;
            border-left: 3px solid #4caf50;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .permitted-reasons h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 400;
        }

        .permitted-reasons ul {
            margin-left: 20px;
        }

        .permitted-reasons li {
            color: #1b5e20;
            margin-bottom: 8px;
            line-height: 1.6;
            font-size: 14px;
        }

        .delay-info {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .delay-info h4 {
            color: #1565c0;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 400;
        }

        .delay-info p {
            color: #0d47a1;
            margin-bottom: 8px;
            line-height: 1.6;
            font-size: 14px;
        }

        .delay-info ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .delay-info li {
            color: #0d47a1;
            margin-bottom: 8px;
            line-height: 1.6;
            font-size: 14px;
        }

        .submission-info {
            background: #fce4ec;
            border-left: 3px solid #e91e63;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .submission-info h4 {
            color: #ad1457;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 400;
        }

        .submission-info p {
            color: #880e4f;
            margin-bottom: 8px;
            line-height: 1.6;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="content">
            <!-- Information Section -->
            <div class="section">
                <div class="info-box">
                    <h3>SET(O) Absence Requirements for 5-Year Route to ILR</h3>
                    <p>For your SET(O) application to be successful, you must meet ALL of these requirements:</p>
                    <ul>
                        <li><strong>No more than 180 days</strong> absence in any 12-month rolling period</li>
                        <li><strong>No single continuous absence longer than 180 days</strong> for any leave granted after 11 January 2018</li>
                        <li><strong>Total absences must not exceed 450 days</strong> over the entire 5-year qualifying period</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Important:</strong> Only absences within your 5-year qualifying period count. Absences before 11 January 2018 are counted in separate consecutive 12-month periods. Absences after 11 January 2018 are calculated on a rolling basis.</p>
                </div>

                <div class="delay-info">
                    <h4>Entry Clearance to UK Entry Period</h4>
                    <p>The period between your visa being issued and entering the UK can count toward your qualifying period, subject to these rules:</p>
                    <ul>
                        <li>If the delay is <strong>180 days or less</strong>: The time between visa issue and UK entry counts toward the continuous period, and any absences during this time count toward the 180-day allowance.</li>
                        <li>If the delay is <strong>more than 180 days</strong>: Only time after entering the UK counts toward the continuous period.</li>
                        <li>You do not need to provide evidence for the reason for delayed entry.</li>
                    </ul>
                </div>

                <div class="submission-info">
                    <h4>Application Submission Date</h4>
                    <p>You can apply up to 28 days before your eligibility date. Only absences <strong>before</strong> your application submission date count toward the absence limits. Any absences after you submit your application are excluded from the calculation.</p>
                    <p><strong>Strategy:</strong> If you're close to the absence limits, you may choose to submit your application earlier (within the 28-day window) to exclude recent or upcoming trips that would push you over the allowance.</p>
                </div>

                <div class="permitted-reasons">
                    <h4>Permitted Absences (These DO NOT count towards your limits):</h4>
                    <ul>
                        <li>Assisting with national or international humanitarian or environmental crisis overseas</li>
                        <li>Travel disruption due to natural disaster, military conflict or pandemic</li>
                        <li>Compelling and compassionate personal circumstances (e.g., life-threatening illness of applicant or close family member)</li>
                        <li>Research activity for Skilled Workers in specified occupation codes (2111-2119, 2161-2162, 2311)</li>
                    </ul>
                </div>
            </div>

            <!-- Key Dates Section -->
            <div class="section">
                <h2 class="section-title">Your Immigration Timeline</h2>
                
                <div class="form-group">
                    <label for="decisionDate">Date of Last Immigration Decision (Visa Grant/Issue Date)</label>
                    <input type="date" id="decisionDate" required>
                </div>

                <div class="form-group">
                    <label for="entryDate">Date of Entry to the UK</label>
                    <input type="date" id="entryDate" required>
                </div>

                <div id="eligibilityInfo" class="hidden"></div>

                <div class="form-group" id="submissionDateGroup" class="hidden">
                    <label for="submissionDate">Planned ILR Application Submission Date (Optional)</label>
                    <input type="date" id="submissionDate">
                    <p style="margin-top: 10px; color: #666; font-size: 14px; line-height: 1.6;">
                        Enter your planned submission date to see which absences will count. Only absences before this date will be included in the calculation. You can submit up to 28 days before your eligibility date.
                    </p>
                </div>

                <div id="submissionInfo" class="hidden"></div>
            </div>

            <!-- Add Trip Section -->
            <div class="section">
                <h2 class="section-title">Record Your Absences from the UK</h2>
                
                <div class="info-box" style="background: #e3f2fd; border-left-color: #2196f3;">
                    <p style="color: #0d47a1;"><strong>Note:</strong> If you were outside the UK between your visa issue date and entry date, you can record this as an absence. This period may count toward your qualifying period depending on the delay length.</p>
                </div>

                <div class="form-group">
                    <label for="reason">Reason for Absence</label>
                    <select id="reason">
                        <option value="">Select a reason...</option>
                        <option value="Pre-Entry">Between Visa Issue and UK Entry</option>
                        <option value="Holiday">Holiday</option>
                        <option value="Business">Business Trip</option>
                        <option value="Family Emergency">Family Emergency</option>
                        <option value="Medical">Medical Reasons</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="isPermitted">
                    <label for="isPermitted">This absence is for a permitted reason (humanitarian crisis, travel disruption, compelling circumstances, or approved research activity) and should NOT count towards my absence limits</label>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label for="departDate">Departure Date (Left UK) / Start of Absence</label>
                        <input type="date" id="departDate">
                    </div>

                    <div class="form-group">
                        <label for="returnDate">Return Date (Entered UK) / End of Absence</label>
                        <input type="date" id="returnDate">
                    </div>
                </div>

                <button class="button" onclick="addTrip()">Add This Absence</button>

                <div id="tripsList" class="trips-list"></div>
            </div>

            <!-- Calculate Section -->
            <div class="section">
                <h2 class="section-title">Calculate Your Results</h2>
                <button class="button" onclick="calculate()">Calculate Total Absences</button>
                <button class="button button-secondary" onclick="resetAll()">Start Over</button>

                <div id="results" class="hidden"></div>
            </div>

            <!-- Important Notes -->
            <div class="section">
                <div class="warning">
                    <p><strong>Important Notes:</strong></p>
                    <p>• Both departure and arrival days count as full absence days</p>
                    <p>• You can apply up to 28 days before your eligibility date</p>
                    <p>• Only absences before your submission date count toward limits</p>
                    <p>• Only absences within the 5-year qualifying period count</p>
                    <p>• Absences before 11 January 2018 are counted in separate consecutive 12-month periods</p>
                    <p>• Absences after 11 January 2018 are calculated on a rolling 12-month basis</p>
                    <p>• Keep all travel documents (boarding passes, tickets, passport stamps) as evidence</p>
                    <p>• Keep evidence for any permitted absences (medical certificates, employer letters, etc.)</p>
                    <p>• This calculator is for guidance only and does not constitute official legal advice</p>
                    <p>• For specialist immigration advice, please contact our team</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let trips = [];
        const JAN_11_2018 = new Date('2018-01-11');

        function calculateEligibilityDates() {
            const decisionDate = document.getElementById('decisionDate').value;
            const entryDate = document.getElementById('entryDate').value;

            if (!decisionDate || !entryDate) {
                document.getElementById('eligibilityInfo').classList.add('hidden');
                document.getElementById('submissionDateGroup').classList.add('hidden');
                document.getElementById('submissionInfo').classList.add('hidden');
                return;
            }

            const decisionDateObj = new Date(decisionDate);
            const entryDateObj = new Date(entryDate);

            // Calculate delay between visa issue and entry
            const delayDays = Math.floor((entryDateObj - decisionDateObj) / (1000 * 60 * 60 * 24));

            let qualifyingPeriodStart;
            let eligibilityDate;
            let earliestApplicationDate;
            let warningMessage = '';
            let boxClass = 'eligibility-box';

            if (delayDays <= 180) {
                qualifyingPeriodStart = new Date(decisionDateObj);
                eligibilityDate = new Date(decisionDateObj);
                eligibilityDate.setFullYear(eligibilityDate.getFullYear() + 5);
                
                warningMessage = `Your delay between visa issue and UK entry was ${delayDays} days (within the 180-day allowance). The qualifying period starts from your visa issue date, and any absences between visa issue and entry count toward your 180-day limit.`;
            } else {
                qualifyingPeriodStart = new Date(entryDateObj);
                eligibilityDate = new Date(entryDateObj);
                eligibilityDate.setFullYear(eligibilityDate.getFullYear() + 5);
                
                warningMessage = `Your delay between visa issue and UK entry was ${delayDays} days (more than 180 days). Therefore, the qualifying period starts from your UK entry date, not the visa issue date.`;
                boxClass = 'eligibility-box warning';
            }

            earliestApplicationDate = new Date(eligibilityDate);
            earliestApplicationDate.setDate(earliestApplicationDate.getDate() - 28);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let statusMessage = '';
            if (today >= earliestApplicationDate) {
                statusMessage = '✓ You can apply for SET(O) now!';
                boxClass = 'eligibility-box';
            } else {
                const daysUntilEarliestApp = Math.ceil((earliestApplicationDate - today) / (1000 * 60 * 60 * 24));
                statusMessage = `You cannot apply yet. You can apply from ${formatDate(earliestApplicationDate)} (in ${daysUntilEarliestApp} days).`;
                boxClass = 'eligibility-box error';
            }

            const eligibilityDiv = document.getElementById('eligibilityInfo');
            eligibilityDiv.className = boxClass;
            eligibilityDiv.classList.remove('hidden');
            eligibilityDiv.innerHTML = `
                <h4>Your Eligibility Timeline</h4>
                <p><strong>Qualifying Period Starts:</strong> ${formatDate(qualifyingPeriodStart)}</p>
                <p><strong>Eligibility Date (5 years):</strong> ${formatDate(eligibilityDate)}</p>
                <p><strong>Earliest Application Date (28 days before):</strong> ${formatDate(earliestApplicationDate)}</p>
                <p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);"><strong>${statusMessage}</strong></p>
                ${delayDays !== 0 ? `<p style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.05); border-radius: 0;">${warningMessage}</p>` : ''}
            `;

            // Show submission date field
            document.getElementById('submissionDateGroup').classList.remove('hidden');
            
            // Set min and max for submission date
            const submissionDateInput = document.getElementById('submissionDate');
            submissionDateInput.min = earliestApplicationDate.toISOString().split('T')[0];
            submissionDateInput.max = eligibilityDate.toISOString().split('T')[0];

            window.qualifyingPeriodStart = qualifyingPeriodStart;
            window.eligibilityDate = eligibilityDate;
            window.earliestApplicationDate = earliestApplicationDate;
            window.delayDays = delayDays;

            updateSubmissionInfo();
            displayTrips();
        }

        function updateSubmissionInfo() {
            const submissionDate = document.getElementById('submissionDate').value;
            const submissionInfoDiv = document.getElementById('submissionInfo');

            if (!submissionDate || !window.earliestApplicationDate || !window.eligibilityDate) {
                submissionInfoDiv.classList.add('hidden');
                window.submissionDateObj = null;
                displayTrips();
                return;
            }

            const submissionDateObj = new Date(submissionDate);
            const earliestApp = window.earliestApplicationDate;
            const eligibility = window.eligibilityDate;

            if (submissionDateObj < earliestApp || submissionDateObj > eligibility) {
                submissionInfoDiv.className = 'eligibility-box error';
                submissionInfoDiv.classList.remove('hidden');
                submissionInfoDiv.innerHTML = `
                    <h4>Invalid Submission Date</h4>
                    <p>Your submission date must be between ${formatDate(earliestApp)} and ${formatDate(eligibility)}.</p>
                `;
                window.submissionDateObj = null;
                displayTrips();
                return;
            }

            const daysBeforeEligibility = Math.ceil((eligibility - submissionDateObj) / (1000 * 60 * 60 * 24));

            submissionInfoDiv.className = 'eligibility-box';
            submissionInfoDiv.classList.remove('hidden');
            submissionInfoDiv.innerHTML = `
                <h4>Planned Submission Date: ${formatDate(submissionDateObj)}</h4>
                <p>You are planning to submit ${daysBeforeEligibility} day${daysBeforeEligibility !== 1 ? 's' : ''} before your eligibility date.</p>
                <p style="margin-top: 10px;"><strong>Important:</strong> Only absences ending before ${formatDate(submissionDateObj)} will count toward your absence limits. Any trips after this date will be excluded from calculations.</p>
            `;

            window.submissionDateObj = submissionDateObj;
            displayTrips();
        }

        document.getElementById('decisionDate').addEventListener('change', calculateEligibilityDates);
        document.getElementById('entryDate').addEventListener('change', calculateEligibilityDates);
        document.getElementById('submissionDate').addEventListener('change', updateSubmissionInfo);

        function formatDate(date) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-GB', options);
        }

        function addTrip() {
            const reason = document.getElementById('reason').value;
            const departDate = document.getElementById('departDate').value;
            const returnDate = document.getElementById('returnDate').value;
            const isPermitted = document.getElementById('isPermitted').checked;

            if (!reason || !departDate || !returnDate) {
                alert('Please fill in all fields');
                return;
            }

            const depart = new Date(departDate);
            const returnD = new Date(returnDate);

            if (returnD < depart) {
                alert('Return date must be after departure date');
                return;
            }

            const days = Math.floor((returnD - depart) / (1000 * 60 * 60 * 24)) + 1;

            const trip = {
                id: Date.now(),
                reason,
                departDate,
                returnDate,
                days,
                isPermitted,
                isPreEntry: reason === 'Pre-Entry'
            };

            trips.push(trip);
            displayTrips();
            clearForm();
        }

        function isOutsideQualifyingPeriod(trip) {
            if (!window.qualifyingPeriodStart || !window.eligibilityDate) return false;

            const tripReturn = new Date(trip.returnDate);
            const tripDepart = new Date(trip.departDate);
            
            if (trip.isPreEntry && window.delayDays <= 180) {
                return false;
            }

            return tripReturn < window.qualifyingPeriodStart;
        }

        function isAfterSubmission(trip) {
            if (!window.submissionDateObj) return false;
            
            const tripDepart = new Date(trip.departDate);
            return tripDepart >= window.submissionDateObj;
        }

        function displayTrips() {
            const list = document.getElementById('tripsList');
            
            if (trips.length === 0) {
                list.innerHTML = '';
                return;
            }

            list.innerHTML = trips.map(trip => {
                const outsidePeriod = isOutsideQualifyingPeriod(trip);
                const afterSubmission = isAfterSubmission(trip);
                const excluded = outsidePeriod || afterSubmission;
                
                return `
                <div class="trip-item ${trip.isPermitted ? 'permitted' : ''} ${outsidePeriod ? 'outside-period' : ''} ${trip.isPreEntry && !outsidePeriod && !afterSubmission ? 'pre-entry' : ''} ${afterSubmission ? 'after-submission' : ''}">
                    <div class="trip-info">
                        <strong>${trip.reason}</strong>
                        <span>${formatDate(new Date(trip.departDate))} → ${formatDate(new Date(trip.returnDate))}</span>
                        ${trip.isPermitted && !excluded ? '<div class="trip-badge">PERMITTED ABSENCE</div>' : ''}
                        ${trip.isPreEntry && !outsidePeriod && !afterSubmission ? '<div class="trip-badge pre-entry">PRE-ENTRY PERIOD</div>' : ''}
                        ${outsidePeriod ? '<div class="trip-badge excluded">OUTSIDE QUALIFYING PERIOD - EXCLUDED</div>' : ''}
                        ${afterSubmission ? '<div class="trip-badge after-submission">AFTER SUBMISSION - EXCLUDED</div>' : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="trip-days ${trip.isPermitted && !excluded ? 'permitted' : ''} ${excluded ? 'excluded' : ''} ${trip.isPreEntry && !outsidePeriod && !afterSubmission ? 'pre-entry' : ''} ${afterSubmission ? 'after-submission' : ''}">${trip.days} days</div>
                        <button class="remove-btn" onclick="removeTrip(${trip.id})">Remove</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function removeTrip(id) {
            trips = trips.filter(trip => trip.id !== id);
            displayTrips();
        }

        function clearForm() {
            document.getElementById('reason').value = '';
            document.getElementById('departDate').value = '';
            document.getElementById('returnDate').value = '';
            document.getElementById('isPermitted').checked = false;
        }

        function calculate() {
            const decisionDate = document.getElementById('decisionDate').value;
            const entryDate = document.getElementById('entryDate').value;

            if (!decisionDate || !entryDate) {
                alert('Please enter your visa decision date and UK entry date first');
                return;
            }

            if (!window.qualifyingPeriodStart || !window.eligibilityDate) {
                alert('Please ensure all dates are entered correctly');
                return;
            }

            if (trips.length === 0) {
                alert('Please add at least one absence');
                return;
            }

            const qualifyingPeriodStart = window.qualifyingPeriodStart;
            const eligibilityDate = window.eligibilityDate;
            const submissionDate = window.submissionDateObj || eligibilityDate;

            // Filter trips: within qualifying period AND before submission date
            const tripsInPeriod = trips.filter(trip => {
                // Check if after submission
                if (isAfterSubmission(trip)) {
                    return false;
                }

                // Check if pre-entry and allowed
                if (trip.isPreEntry && window.delayDays <= 180) {
                    return true;
                }
                
                const tripReturn = new Date(trip.returnDate);
                const tripDepart = new Date(trip.departDate);
                
                return tripReturn >= qualifyingPeriodStart && tripDepart < submissionDate;
            });

            // Adjust days for trips that partially overlap
            const adjustedTrips = tripsInPeriod.map(trip => {
                const tripDepart = new Date(trip.departDate);
                const tripReturn = new Date(trip.returnDate);
                
                const effectiveStart = tripDepart < qualifyingPeriodStart ? qualifyingPeriodStart : tripDepart;
                const effectiveEnd = tripReturn > submissionDate ? submissionDate : tripReturn;
                
                const adjustedDays = Math.floor((effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24)) + 1;
                
                return {
                    ...trip,
                    originalDays: trip.days,
                    days: adjustedDays > 0 ? adjustedDays : 0
                };
            }).filter(trip => trip.days > 0);

            const excludedTrips = trips.filter(trip => !tripsInPeriod.includes(trip));
            const afterSubmissionTrips = trips.filter(trip => isAfterSubmission(trip));

            const permittedTrips = adjustedTrips.filter(t => t.isPermitted);
            const countableTrips = adjustedTrips.filter(t => !t.isPermitted);
            const preEntryTrips = countableTrips.filter(t => t.isPreEntry);
            const regularTrips = countableTrips.filter(t => !t.isPreEntry);

            const totalPermittedDays = permittedTrips.reduce((sum, trip) => sum + trip.days, 0);
            const totalCountableDays = countableTrips.reduce((sum, trip) => sum + trip.days, 0);
            const preEntryDays = preEntryTrips.reduce((sum, trip) => sum + trip.days, 0);

            const longestTrip = countableTrips.length > 0 ? Math.max(...countableTrips.map(trip => trip.days)) : 0;

            // Rolling 12-month periods for post-Jan 2018
            let maxRolling12Months = 0;
            let maxRollingPeriod = '';
            
            const postJan2018Trips = countableTrips.filter(t => new Date(t.departDate) >= JAN_11_2018);
            
            if (postJan2018Trips.length > 0) {
                for (let trip of postJan2018Trips) {
                    const tripStart = new Date(trip.departDate);
                    const twelveMonthsLater = new Date(tripStart);
                    twelveMonthsLater.setFullYear(twelveMonthsLater.getFullYear() + 1);
                    
                    const periodEnd = twelveMonthsLater > submissionDate ? submissionDate : twelveMonthsLater;
                    
                    const tripsInRollingPeriod = countableTrips.filter(t => {
                        const tStart = new Date(t.departDate);
                        const tEnd = new Date(t.returnDate);
                        return (tStart >= tripStart && tStart < periodEnd) ||
                               (tEnd >= tripStart && tEnd < periodEnd) ||
                               (tStart < tripStart && tEnd >= periodEnd);
                    });
                    
                    const daysInPeriod = tripsInRollingPeriod.reduce((sum, t) => {
                        const tStart = new Date(t.departDate);
                        const tEnd = new Date(t.returnDate);
                        const periodStart = tStart < tripStart ? tripStart : tStart;
                        const periodEndDate = tEnd > periodEnd ? periodEnd : tEnd;
                        const days = Math.floor((periodEndDate - periodStart) / (1000 * 60 * 60 * 24)) + 1;
                        return sum + days;
                    }, 0);
                    
                    if (daysInPeriod > maxRolling12Months) {
                        maxRolling12Months = daysInPeriod;
                        maxRollingPeriod = `${formatDate(tripStart)} to ${formatDate(periodEnd)}`;
                    }
                }
            }

            // Consecutive 12-month periods for pre-Jan 2018
            let maxConsecutive12Months = 0;
            let maxConsecutivePeriod = '';
            
            const preJan2018Trips = countableTrips.filter(t => new Date(t.departDate) < JAN_11_2018);
            
            if (preJan2018Trips.length > 0) {
                let currentDate = new Date(qualifyingPeriodStart);
                while (currentDate < JAN_11_2018) {
                    const periodEnd = new Date(currentDate);
                    periodEnd.setFullYear(periodEnd.getFullYear() + 1);
                    
                    const tripsInPeriod = countableTrips.filter(t => {
                        const tStart = new Date(t.departDate);
                        const tEnd = new Date(t.returnDate);
                        return (tStart >= currentDate && tStart < periodEnd) ||
                               (tEnd >= currentDate && tEnd < periodEnd) ||
                               (tStart < currentDate && tEnd >= periodEnd);
                    });
                    
                    const daysInPeriod = tripsInPeriod.reduce((sum, t) => {
                        const tStart = new Date(t.departDate);
                        const tEnd = new Date(t.returnDate);
                        const periodStart = tStart < currentDate ? currentDate : tStart;
                        const actualPeriodEnd = periodEnd < JAN_11_2018 ? periodEnd : JAN_11_2018;
                        const periodEndDate = tEnd > actualPeriodEnd ? actualPeriodEnd : tEnd;
                        const days = Math.floor((periodEndDate - periodStart) / (1000 * 60 * 60 * 24)) + 1;
                        return sum + days;
                    }, 0);
                    
                    if (daysInPeriod > maxConsecutive12Months) {
                        maxConsecutive12Months = daysInPeriod;
                        maxConsecutivePeriod = `${formatDate(currentDate)} to ${formatDate(periodEnd < JAN_11_2018 ? periodEnd : JAN_11_2018)}`;
                    }
                    
                    currentDate = periodEnd;
                }
            }

            const meetsTotal = totalCountableDays <= 450;
            const meetsRolling = maxRolling12Months <= 180;
            const meetsConsecutive = maxConsecutive12Months <= 180;
            const meetsLongest = longestTrip <= 180;
            
            const passes = meetsTotal && meetsRolling && meetsConsecutive && meetsLongest;

            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('hidden');

            let warningMessages = [];
            if (!meetsTotal) warningMessages.push(`You have exceeded the 450-day total limit by ${totalCountableDays - 450} days.`);
            if (!meetsRolling && maxRolling12Months > 0) warningMessages.push(`You exceeded the 180-day rolling 12-month limit (${maxRolling12Months} days in period: ${maxRollingPeriod}).`);
            if (!meetsConsecutive && maxConsecutive12Months > 0) warningMessages.push(`You exceeded the 180-day consecutive 12-month limit for pre-Jan 2018 absences (${maxConsecutive12Months} days in period: ${maxConsecutivePeriod}).`);
            if (!meetsLongest) warningMessages.push(`Your longest single absence (${longestTrip} days) exceeds the 180-day limit.`);

            resultsDiv.innerHTML = `
                <div class="results">
                    <h3>Your Absence Summary</h3>
                    
                    <div class="result-item">
                        <strong>Qualifying Period</strong>
                        <div class="sub-value">${formatDate(qualifyingPeriodStart)} to ${formatDate(eligibilityDate)}</div>
                    </div>

                    ${window.submissionDateObj ? `
                    <div class="result-item" style="background: rgba(233, 30, 99, 0.2); border-color: #e91e63;">
                        <strong>Calculation Based on Submission Date</strong>
                        <div class="sub-value">${formatDate(submissionDate)}</div>
                        <div style="margin-top: 10px; opacity: 0.9; font-size: 14px;">Only absences before this date are counted</div>
                    </div>
                    ` : ''}

                    ${afterSubmissionTrips.length > 0 ? `
                    <div class="result-item" style="background: rgba(233, 30, 99, 0.2); border-color: #e91e63;">
                        <strong>Excluded Absences (After Submission Date)</strong>
                        <div class="value">${afterSubmissionTrips.length}</div>
                        <div class="sub-value">${afterSubmissionTrips.reduce((sum, t) => sum + t.days, 0)} days excluded from calculation</div>
                    </div>
                    ` : ''}

                    ${excludedTrips.length > 0 && excludedTrips.some(t => !isAfterSubmission(t)) ? `
                    <div class="result-item" style="background: rgba(255, 193, 7, 0.2); border-color: #ffc107;">
                        <strong>Excluded Absences (Outside Qualifying Period)</strong>
                        <div class="value">${excludedTrips.filter(t => !isAfterSubmission(t)).length}</div>
                        <div class="sub-value">These absences are before your qualifying period and are not counted</div>
                    </div>
                    ` : ''}

                    <div class="result-item">
                        <strong>Total Counted Absences</strong>
                        <div class="value">${tripsInPeriod.length}</div>
                        <div class="sub-value">${countableTrips.length} countable | ${permittedTrips.length} permitted</div>
                    </div>

                    <div class="result-item">
                        <strong>Total Countable Days Outside UK</strong>
                        <div class="value">${totalCountableDays} days</div>
                        ${preEntryDays > 0 ? `<div class="sub-value">(includes ${preEntryDays} days pre-entry)</div>` : ''}
                        <div style="margin-top: 10px; opacity: 0.9;">Limit: 450 days over 5 years ${meetsTotal ? '✓' : '✗'}</div>
                    </div>

                    ${totalPermittedDays > 0 ? `
                    <div class="result-item">
                        <strong>Total Permitted Absence Days (Not Counted)</strong>
                        <div class="value">${totalPermittedDays} days</div>
                        <div style="margin-top: 10px; opacity: 0.9;">These do not count towards your limits</div>
                    </div>
                    ` : ''}

                    <div class="result-item">
                        <strong>Longest Single Absence</strong>
                        <div class="value">${longestTrip} days</div>
                        <div style="margin-top: 10px; opacity: 0.9;">Limit: 180 days ${meetsLongest ? '✓' : '✗'}</div>
                    </div>

                    ${maxRolling12Months > 0 ? `
                    <div class="result-item">
                        <strong>Maximum in Any Rolling 12-Month Period (Post-Jan 2018)</strong>
                        <div class="value">${maxRolling12Months} days</div>
                        <div style="margin-top: 10px; opacity: 0.9;">Limit: 180 days ${meetsRolling ? '✓' : '✗'}</div>
                        ${maxRollingPeriod ? `<div style="margin-top: 5px; opacity: 0.8; font-size: 14px;">Period: ${maxRollingPeriod}</div>` : ''}
                    </div>
                    ` : ''}

                    ${maxConsecutive12Months > 0 ? `
                    <div class="result-item">
                        <strong>Maximum in Consecutive 12-Month Period (Pre-Jan 2018)</strong>
                        <div class="value">${maxConsecutive12Months} days</div>
                        <div style="margin-top: 10px; opacity: 0.9;">Limit: 180 days ${meetsConsecutive ? '✓' : '✗'}</div>
                        ${maxConsecutivePeriod ? `<div style="margin-top: 5px; opacity: 0.8; font-size: 14px;">Period: ${maxConsecutivePeriod}</div>` : ''}
                    </div>
                    ` : ''}

                    <div class="status ${passes ? 'pass' : 'fail'}">
                        ${passes ? '✓ You Meet the SET(O) Absence Requirements' : '✗ You Do Not Meet the Requirements'}
                    </div>

                    ${!passes && window.submissionDateObj ? `
                        <div class="warning" style="margin-top: 25px; background: rgba(255, 193, 7, 0.2); border-color: #ffc107;">
                            <p style="color: #856404;"><strong>Tip:</strong> You may want to adjust your submission date to exclude additional trips and meet the requirements. Try submitting earlier within the 28-day window.</p>
                        </div>
                    ` : ''}

                    ${!passes ? `
                        <div class="warning" style="margin-top: 25px; background: rgba(255, 255, 255, 0.15); border-color: #ffc107;">
                            <p style="color: white;"><strong>What This Means:</strong></p>
                            ${warningMessages.map(msg => `<p style="color: white;">${msg}</p>`).join('')}
                            <p style="color: white; margin-top: 15px;">We strongly recommend consulting an immigration advisor to discuss your options. Please contact our team for specialist advice.</p>
                        </div>
                    ` : ''}

                    ${passes && window.submissionDateObj ? `
                        <div class="warning" style="margin-top: 25px; background: rgba(76, 175, 80, 0.2); border-color: #4caf50;">
                            <p style="color: #2e7d32;"><strong>Success!</strong> Based on your planned submission date of ${formatDate(submissionDate)}, you meet all absence requirements.</p>
                        </div>
                    ` : ''}
                </div>
            `;

            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function resetAll() {
            if (confirm('Are you sure you want to clear all data and start over?')) {
                trips = [];
                document.getElementById('entryDate').value = '';
                document.getElementById('decisionDate').value = '';
                document.getElementById('submissionDate').value = '';
                document.getElementById('eligibilityInfo').classList.add('hidden');
                document.getElementById('submissionDateGroup').classList.add('hidden');
                document.getElementById('submissionInfo').classList.add('hidden');
                document.getElementById('results').classList.add('hidden');
                window.qualifyingPeriodStart = null;
                window.eligibilityDate = null;
                window.earliestApplicationDate = null;
                window.delayDays = null;
                window.submissionDateObj = null;
                displayTrips();
                clearForm();
            }
        }
    </script>
</body>
</html>
